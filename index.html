<!DOCTYPE html>
<html>
<head>
    <title>Workout Architect</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; padding: 50px; text-align: center; }
        .box { background: #222; padding: 20px; border: 2px solid #ffcc00; border-radius: 10px; display: inline-block; text-align: left; }
        button { background: #ffcc00; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }
        input[type="text"], input[type="number"] {
            background: #333;
            color: white;
            border: 1px solid #ffcc00;
            padding: 5px;
            border-radius: 4px;
        }

        select {
            background: #333;
            color: white;
            border: 1px solid #ffcc00;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }

        input[type="checkbox"]:checked {
            accent-color: #ffcc00;
        }
    </style>
</head>
<body>
    <div class="box">
        <h1>üèãÔ∏è PF Workout Builder</h1>
        <label>Time (mins):</label> <input type="number" id="mins" value="60"><br><br>
        <div style="margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px;">
            <label>Select Your Gym:</label>
            <select id="club-select" onchange="syncLiveCrowd()">
                <option value="">-- Choose a Location --</option>
                <option value="perry-hall-md">Perry Hall, MD (Verified)</option>
                <option value="maryland-honeygo">Honeygo, MD (Verified)</option>
                <option value="white-marsh-md">White Marsh, MD (Verified)</option>
            </select>
        </div>

        <label>Live Occupancy:</label> 
        <input type="range" id="crowd" min="0" max="100" value="50"
            oninput="document.getElementById('crowd-val').innerText = this.value + '%'">
        <output id="crowd-val">50%</output>

        <div style="margin-top: 20px; text-align: left;"></div>
            <strong>Select Muscles:</strong><br>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <label><input type="checkbox" name="muscle" value="chest"> Chest<br></label>
                <label><input type="checkbox" name="muscle" value="back"> Back<br></label>
                <label><input type="checkbox" name="muscle" value="legs"> Legs<br></label>
                <label><input type="checkbox" name="muscle" value="arms"> Arms<br></label>
                <label><input type="checkbox" name="muscle" value="shoulders"> Shoulders<br></label>
                <label><input type="checkbox" name="muscle" value="core"> Core<br></label>
            </div>
        <button onclick="fetchWorkout()">Generate Workout</button>
        <div id="results" style="margin-top:20px;"></div>
    </div>

    <script>
    async function searchPF() {
        const query = document.getElementById('club-search').value;
        const select = document.getElementById('club-select');
        if (!query) {
            alert("Please enter a zip code or city to search.");
            return;
        }
        try {
            const response = await fetch(`https://pf-workout-builder.onrender.com/search_clubs?query=${query}`);
            if (response.status === 403) {
                const errorData = await response.json();
                alert(errorData.error);
                select.style.display = 'none';
                return;
            }
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            const clubs = await response.json();
            if (clubs.length > 0){
                select.innerHTML = '<option value="">-- Select Your Gym --</option>';
                clubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.id;
                    option.innerText = club.name;
                    select.appendChild(option);
                }); 
                select.style.display = 'block';
            } else {
                alert("No clubs found. Please try a different search.");
            }
        } catch (e) {
            console.error("Error fetching clubs:", e);
            alert("Could not connect to the server. Make sure app.py is running!");
        }
    }
    async function syncLiveCrowd() {
        const select = document.getElementById('club-select');
        const clubId = select.value
        if (!clubId) return;

        const output = document.getElementById('crowd-val');
        const slider = document.getElementById('crowd');
        output.innerText = "Loading...";
        localStorage.setItem('savedClubId', clubId);
        try {
            const response = await fetch(`https://pf-workout-builder.onrender.com/get_crowd?club_id=${clubId}`);
            const data = await response.json();
            
            if (data.crowd !== undefined){
                const numericCrowd = parseInt(data.crowd);
                slider.value = numericCrowd;
                output.innerText = numericCrowd + "%";
                console.log("Slider updated to:", numericCrowd);
            } else {
                console.error("Error: Invalid crowd data", data);
                output.innerText = "Error";
            }
        } catch (e) {
            console.error("Error fetching crowd:", e);
            output.innerText = "Error";
        }
    }
    async function fetchWorkout() {
        const mins = document.getElementById('mins').value;
        const crowd = document.getElementById('crowd').value; 
        const checked = document.querySelectorAll('input[name="muscle"]:checked');
        const muscles = Array.from(checked).map(c => c.value).join(',') || "All";
        const resultsDiv = document.getElementById('results');
        
        resultsDiv.innerHTML = "Processing...";

        try {
            const response = await fetch(`https://pf-workout-builder.onrender.com/generate_workout?mins=${mins}&crowd=${crowd}&muscle=${muscles}`);
            
            const data = await response.json();
            
            resultsDiv.innerHTML = `<h3>Plan (${data.total_time_mins} min)</h3>`;
            const totalSets = data.workout_plan.reduce((sum, ex) => sum + ex.sets, 0);
            resultsDiv.innerHTML += `
                <div style="width: 100%; background: #444; height: 10px; border-radius: 5px; margin-bottom: 20px;">
                    <div id="progress-bar" style="width: 0%; background: #ffcc00; height: 100%; border-radius: 5px; transition: width 0.5s;"></div>
                </div>
                <p id="progress-text" style="font-size: 12px; margin-bottom: 20px;">0 / ${totalSets} sets completed</p>
            `;
            data.workout_plan.forEach((ex, index) => {
                const timerId = `timer-${index}`;
                const restTime = ex.rest;
                const workTime = 60;

                let setCheckboxes = "";
                for (let i = 1; i <= ex.sets; i++){
                    setCheckboxes += `
                        <label style="margin-right:10px;">
                            <input type="checkbox" id="check-${index}-${i}" disabled> Set ${i}
                        </label>`;
                }

    
                resultsDiv.innerHTML += `
                    <div style="margin-bottom: 20px; padding: 15px; border-bottom: 1px solid #ffcc00; border-radius: 8px; background: #2a2a2a;">
                        <strong>‚úÖ ${ex.name}</strong> (${ex.muscle})<br>
                        <small>${ex.sets} sets x ${ex.reps} reps</small><br><br>
                        <div style="margin-bottom: 10px;">${setCheckboxes}</div>
                        <button id="work-${timerId}"
                            style="width: 48%; background: #00ccff; color: black;"
                            onclick="startTimer('work-${timerId}', ${workTime}, 'Work')">
                            ‚ñ∂Ô∏è Start Set
                        </button>
                        <button id="rest-${timerId}"
                            style="width: 48%; background: #ffcc00; color: black;"
                            onclick="startTimer('rest-${timerId}', ${restTime}, 'Rest')">
                            ‚è≥ Rest (${restTime}s)
                        </button>
                    </div>`;

            });
        } catch (e) {
            resultsDiv.innerHTML = "Error: Is app.py running?";
        }
    }

    const currentSetTracker = {};
    function startTimer(id, seconds, type) {
        const btn = document.getElementById(id);
        const originalText = btn.innerText;
        let timeLeft = seconds;
        
        const exIndex = id.split('-').pop();
        btn.disabled = true;

        const interval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(interval);
                if (type === 'Work'){
                    let currentSet = currentSetTracker[exIndex] || 1;
                    if (!currentSetTracker[exIndex]) currentSetTracker[exIndex] = 1;
                    const checkbox = document.getElementById(`check-${exIndex}-${currentSetTracker[exIndex]}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        currentSetTracker[exIndex]++;
                        const allChecked = document.querySelectorAll('#results input[type="checkbox"]:checked').length;
                        const totalCheckboxes = document.querySelectorAll('#results input[type="checkbox"]').length;
                        const progressPercent = (allChecked / totalCheckboxes) * 100;
                        document.getElementById('progress-bar').style.width = progressPercent + '%';
                        document.getElementById('progress-text').innerText = `${allChecked} / ${totalCheckboxes} sets completed`;
                        if (allChecked === totalCheckboxes){
                            btn.innerText = "üéâ Workout Complete!";
                            btn.style.background = "#ffcc00";
                        } else{
                            btn.innerText ="üí™ Set Complete!";
                        }
                    }
                } else {
                    btn.innerText = "üí™ Next Set!";
                }
                btn.disabled = false;
                setTimeout(() => { btn.innerText = originalText; }, 3000);
            } else {
                btn.innerText = `${type}: ${timeLeft}s`;
                timeLeft--;
            }
        }, 1000);
    }
    window.onload = async function() {
        const savedId = localStorage.getItem('savedClubId');
        if (savedId) {
            console.log("Loading saved gym ID:", savedId);
            try {
                const response = await fetch(`https://pf-workout-builder.onrender.com/get_crowd?club_id=${savedId}`);
                const data = await response.json();
            
                document.getElementById('crowd').value = data.crowd;
                document.getElementById('crowd-val').innerText = `${data.crowd}%`;
            
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div style="background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <small style="color: #ffcc00;">Loaded saved gym data.</small>;
                        <button onclick="clearSavedGym()" style="width: auto; padding: 2px 8px; font-size: 10px; margin-top: 0; margin-left: 10px; background: #444; color: #fff;">Change Gym</button>
                        </div>`;
            } catch (e) {
                console.log("Could not auto-load gym data. Is the server on?");
            }
        }
    };
    function clearSavedGym() {
        localStorage.removeItem('savedClubId');
        alert("Saved gym cleared! Search to set a new one.");
        location.reload(); // Refresh to reset UI to default
    }
    </script> 
    </body>
</html>